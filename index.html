<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SISTEMA LOJA DO VOV√î</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://unpkg.com/html5-qrcode"></script>

    <style>
        /* Anima√ß√£o do Menu Lateral */
        #menu-lateral { transition: 0.3s; left: -100%; }
        #menu-lateral.abrir { left: 0; }
        
        /* Controle de Abas */
        .aba-conteudo { display: none; }
        .aba-conteudo.ativa { display: block; }

        /* ESTILOS DE IMPRESS√ÉO (S√≥ funcionam na hora de imprimir) */
        @media print {
            /* Esconde tudo que n√£o √© a etiqueta */
            body * { visibility: hidden; }
            #area-etiqueta, #area-etiqueta * { visibility: visible; }
            
            /* Posiciona a etiqueta no topo da folha */
            #area-etiqueta { 
                position: absolute; 
                left: 0; 
                top: 0; 
                width: 100%; 
                display: flex !important;
                justify-content: center;
                align-items: center;
            }

            /* Escalas de Tamanho Real */
            .print-pequeno { transform: scale(0.6); } /* Chaveiros */
            .print-medio { transform: scale(1.0); }   /* Padr√£o */
            .print-grande { transform: scale(1.5); }  /* Caixas grandes */
            .print-sem { display: none !important; }  /* Sem etiqueta */
        }
    </style>
</head>
<body class="bg-slate-900 text-white font-sans overflow-x-hidden">

    <header class="bg-slate-800 p-4 shadow-lg flex items-center justify-between sticky top-0 z-50">
        <button onclick="toggleMenu()" class="text-white text-2xl focus:outline-none">
            &#9776; </button>
        <h1 class="text-xl font-bold italic tracking-wider">LOJA DO VOV√î</h1>
        <div class="w-8"></div> </header>

    <nav id="menu-lateral" class="fixed top-0 bottom-0 w-64 bg-slate-800 shadow-2xl z-50 p-6 flex flex-col border-r border-slate-700">
        <div class="flex justify-between items-center mb-8">
            <h2 class="text-xl font-bold text-blue-400">MENU</h2>
            <button onclick="toggleMenu()" class="text-red-400 font-bold">X FECHAR</button>
        </div>
        
        <button onclick="mudarAba('etiqueta')" class="text-left py-4 border-b border-slate-700 hover:text-blue-400 flex items-center gap-3 text-lg font-medium">
            üè∑Ô∏è Etiqueta
        </button>
        <button onclick="mudarAba('venda')" class="text-left py-4 border-b border-slate-700 hover:text-blue-400 flex items-center gap-3 text-lg font-medium">
            üõí Venda
        </button>
    </nav>

    <main class="p-4 max-w-md mx-auto mt-4">

        <div id="aba-etiqueta" class="aba-conteudo ativa">
            <div class="bg-slate-800 rounded-2xl p-6 shadow-xl border border-slate-700">
                <h2 class="text-center text-blue-400 text-xs font-bold mb-4 tracking-widest uppercase">Gerador de Etiqueta Profissional</h2>
                
                <div class="grid grid-cols-2 gap-4 mb-4">
                    <div>
                        <label class="block text-gray-400 text-xs font-bold mb-1 ml-1">PRODUTO</label>
                        <input type="text" id="produto-nome" placeholder="Ex: Boia" 
                            class="w-full bg-slate-700 text-white border-none rounded-lg p-3 focus:ring-2 focus:ring-blue-500 font-bold shadow-inner">
                    </div>
                    <div>
                        <label class="block text-gray-400 text-xs font-bold mb-1 ml-1">PRE√áO R$</label>
                        <input type="number" id="produto-preco" placeholder="0.00" 
                            class="w-full bg-slate-700 text-white border-none rounded-lg p-3 focus:ring-2 focus:ring-blue-500 font-bold shadow-inner text-lg">
                    </div>
                </div>

                <div class="mb-6">
                    <label class="block text-gray-400 text-xs font-bold mb-2 ml-1">TAMANHO DA ETIQUETA:</label>
                    <div class="grid grid-cols-2 gap-2"> <button id="btn-pequeno" onclick="selecionarTamanho('pequeno')" 
                            class="btn-tam bg-slate-700 text-gray-400 py-3 rounded-lg text-xs font-bold hover:bg-slate-600 transition border border-slate-600">
                            (Pequeno)
                        </button>
                        
                        <button id="btn-medio" onclick="selecionarTamanho('medio')" 
                            class="btn-tam bg-blue-600 text-white py-3 rounded-lg text-xs font-bold shadow-lg ring-2 ring-blue-400 transition transform scale-105">
                            (M√©dio)
                        </button>
                        
                        <button id="btn-grande" onclick="selecionarTamanho('grande')" 
                            class="btn-tam bg-slate-700 text-gray-400 py-3 rounded-lg text-xs font-bold hover:bg-slate-600 transition border border-slate-600">
                            (Grande)
                        </button>
                        
                        <button id="btn-sem" onclick="selecionarTamanho('sem')" 
                            class="btn-tam bg-slate-700 text-gray-400 py-3 rounded-lg text-xs font-bold hover:bg-slate-600 transition border border-slate-600">
                            (Sem Etiqueta)
                        </button>
                    </div>
                </div>

                <button onclick="gerarEtiqueta()" class="w-full bg-blue-500 hover:bg-blue-400 text-white font-bold py-4 rounded-xl shadow-lg transition active:scale-95 text-lg uppercase tracking-wide">
                    Gerar QR Code
                </button>
            </div>

            <div id="area-etiqueta" class="mt-8 bg-white text-black p-6 rounded-xl hidden flex-col items-center shadow-2xl mx-auto w-64 print-medio">
                <div class="text-center w-full">
                    <h3 id="lbl-nome" class="font-black text-2xl uppercase mb-1 leading-none">NOME</h3>
                    <p class="text-sm text-gray-600 font-bold mb-2">Loja do Vov√¥</p>
                    
                    <div id="qrcode-container" class="flex justify-center my-2"></div>
                    
                    <p id="lbl-preco" class="text-3xl font-black mt-1">R$ 0,00</p>
                </div>
            </div>
            
            <button id="btn-imprimir" onclick="window.print()" class="hidden w-full mt-4 bg-green-600 hover:bg-green-500 text-white font-bold py-3 rounded-lg shadow transition">
                üñ®Ô∏è Imprimir Etiqueta
            </button>
        </div>

        <div id="aba-venda" class="aba-conteudo">
            <div class="bg-slate-800 rounded-2xl p-4 shadow-xl border border-slate-700 mb-4">
                <h2 class="text-center text-blue-400 text-xs font-bold mb-4 tracking-widest uppercase">Leitor de Caixa</h2>
                
                <div id="reader" class="w-full rounded-lg overflow-hidden border-2 border-slate-600 bg-black"></div>
                <p id="status-camera" class="text-center text-xs text-gray-400 mt-2">Aponte para o c√≥digo do produto</p>
            </div>

            <div class="bg-white rounded-t-2xl p-4 min-h-[300px] text-slate-900 shadow-2xl">
                <div class="flex justify-between items-center mb-4 border-b pb-2">
                    <h3 class="font-black text-lg uppercase">Carrinho</h3>
                    <button onclick="limparCarrinho()" class="text-xs text-red-500 font-bold underline">Limpar Tudo</button>
                </div>

                <div id="lista-compras" class="space-y-2 max-h-64 overflow-y-auto">
                    <p class="text-center text-gray-400 text-sm mt-10 italic">Nenhum produto bipado...</p>
                </div>
            </div>

            <div class="fixed bottom-0 left-0 w-full bg-slate-900 p-4 border-t border-slate-700 shadow-2xl z-40">
                <div class="flex justify-between items-center max-w-md mx-auto">
                    <span class="text-gray-400 font-bold">TOTAL A PAGAR:</span>
                    <span id="total-venda" class="text-3xl font-black text-green-400">R$ 0.00</span>
                </div>
            </div>
        </div>

    </main>

    <script>
        // --- VARI√ÅVEIS DO SISTEMA ---
        let carrinho = [];
        let html5QrcodeScanner = null;
        let bloqueioLeitura = false; // TRAVA DE SEGURAN√áA (Para evitar scanner louco)
        let tamanhoSelecionado = 'medio';

        // --- 1. L√ìGICA DE MENU E ABAS ---
        function toggleMenu() {
            document.getElementById('menu-lateral').classList.toggle('abrir');
        }

        function mudarAba(aba) {
            // Fecha menu
            document.getElementById('menu-lateral').classList.remove('abrir');
            
            // Troca conte√∫do
            document.querySelectorAll('.aba-conteudo').forEach(el => el.classList.remove('ativa'));
            document.getElementById(`aba-${aba}`).classList.add('ativa');

            // Gerencia a c√¢mera (S√≥ liga na aba Venda)
            if (aba === 'venda') {
                iniciarCamera();
            } else {
                pararCamera();
            }
        }

        // --- 2. L√ìGICA DE ETIQUETAS (Visual e Tamanho) ---
        function selecionarTamanho(tamanho) {
            tamanhoSelecionado = tamanho;

            // Reseta cor de todos os bot√µes para cinza
            document.querySelectorAll('.btn-tam').forEach(btn => {
                btn.className = "btn-tam bg-slate-700 text-gray-400 py-3 rounded-lg text-xs font-bold hover:bg-slate-600 transition border border-slate-600";
            });

            // Pinta o bot√£o escolhido de AZUL (Destaque Visual)
            const btnAtivo = document.getElementById(`btn-${tamanho}`);
            if(btnAtivo) {
                btnAtivo.className = "btn-tam bg-blue-600 text-white py-3 rounded-lg text-xs font-bold shadow-lg ring-2 ring-blue-400 transition transform scale-105";
            }

            // Ajusta classe de impress√£o (CSS)
            const areaEtiqueta = document.getElementById('area-etiqueta');
            areaEtiqueta.classList.remove('print-pequeno', 'print-medio', 'print-grande', 'print-sem');
            areaEtiqueta.classList.add(`print-${tamanho}`);
        }

        function gerarEtiqueta() {
            const nome = document.getElementById('produto-nome').value;
            const preco = document.getElementById('produto-preco').value;
            
            if (!nome || !preco) {
                alert("Opa! Esqueceu de preencher o nome ou pre√ßo.");
                return;
            }

            // Preenche visual
            document.getElementById('lbl-nome').innerText = nome;
            document.getElementById('lbl-preco').innerText = `R$ ${parseFloat(preco).toFixed(2).replace('.', ',')}`;

            // Gera QR Code
            const areaQr = document.getElementById('qrcode-container');
            areaQr.innerHTML = ""; // Limpa anterior
            
            // Dados comprimidos para o QR (n=nome, p=pre√ßo)
            const dados = JSON.stringify({ n: nome, p: preco });
            
            new QRCode(areaQr, {
                text: dados,
                width: 128,
                height: 128,
                colorDark : "#000000",
                colorLight : "#ffffff",
                correctLevel : QRCode.CorrectLevel.H
            });

            // Mostra resultado
            document.getElementById('area-etiqueta').classList.remove('hidden');
            document.getElementById('area-etiqueta').classList.add('flex');
            document.getElementById('btn-imprimir').classList.remove('hidden');
        }

        // --- 3. L√ìGICA DE VENDAS (Corre√ß√£o do Scanner) ---
        function iniciarCamera() {
            if (html5QrcodeScanner) return; // J√° est√° ligada

            html5QrcodeScanner = new Html5Qrcode("reader");
            const config = { fps: 10, qrbox: { width: 250, height: 250 } };
            
            html5QrcodeScanner.start({ facingMode: "environment" }, config, onScanSuccess)
            .catch(err => {
                document.getElementById('status-camera').innerText = "Erro: C√¢mera n√£o permitida";
            });
        }

        function pararCamera() {
            if (html5QrcodeScanner) {
                html5QrcodeScanner.stop().then(() => {
                    html5QrcodeScanner.clear();
                    html5QrcodeScanner = null;
                }).catch(err => console.log("Erro ao parar c√¢mera"));
            }
        }

        function onScanSuccess(decodedText, decodedResult) {
            // [CORRE√á√ÉO IMPORTANTE] A TRAVA DE LEITURA
            if (bloqueioLeitura) {
                return; // Se estiver travado, ignora essa leitura
            }

            try {
                // 1. Trava o sistema
                bloqueioLeitura = true;
                
                // 2. Feedback Visual na C√¢mera (Borda verde pisca)
                document.getElementById('reader').style.borderColor = "#4ade80"; // Verde

                // 3. Processa Produto
                const produto = JSON.parse(decodedText);
                adicionarAoCarrinho(produto);

                console.log(`Produto lido: ${produto.n}`);

                // 4. Destrava ap√≥s 2.5 segundos (Tempo suficiente para tirar o produto)
                setTimeout(() => {
                    bloqueioLeitura = false;
                    document.getElementById('reader').style.borderColor = "#475569"; // Volta cinza
                }, 2500);

            } catch (error) {
                console.error("QR Code inv√°lido para este sistema");
                bloqueioLeitura = false; // Destrava se der erro
            }
        }

        function adicionarAoCarrinho(item) {
            carrinho.push(item);
            atualizarTelaVendas();
        }

        function removerItem(index) {
            carrinho.splice(index, 1);
            atualizarTelaVendas();
        }

        function limparCarrinho() {
            if(confirm("Tem certeza que deseja apagar tudo?")) {
                carrinho = [];
                atualizarTelaVendas();
            }
        }

        function atualizarTelaVendas() {
            const lista = document.getElementById('lista-compras');
            const totalEl = document.getElementById('total-venda');
            
            lista.innerHTML = "";
            let total = 0;

            if (carrinho.length === 0) {
                lista.innerHTML = '<p class="text-center text-gray-400 text-sm mt-10 italic">Nenhum produto bipado...</p>';
            } else {
                // Desenha a lista de cima para baixo (√∫ltimo item primeiro)
                carrinho.slice().reverse().forEach((item, indexReal) => {
                    // Ajuste de √≠ndice reverso para deletar corretamente
                    const indexOriginal = carrinho.length - 1 - indexReal;
                    
                    total += parseFloat(item.p);
                    
                    lista.innerHTML += `
                        <div class="flex justify-between items-center bg-slate-100 p-3 rounded mb-2 border-l-4 border-blue-500 animate-pulse-once">
                            <div>
                                <p class="font-bold text-slate-800 text-lg leading-none">${item.n}</p>
                                <p class="text-xs text-gray-500">Cod: Auto</p>
                            </div>
                            <div class="flex items-center gap-3">
                                <span class="font-bold text-slate-700">R$ ${parseFloat(item.p).toFixed(2)}</span>
                                <button onclick="removerItem(${indexOriginal})" class="bg-red-100 text-red-600 w-8 h-8 rounded-full font-bold hover:bg-red-200">X</button>
                            </div>
                        </div>
                    `;
                });
            }

            totalEl.innerText = `R$ ${total.toFixed(2)}`;
        }
    </script>
</body>
</html>
